@model HotelBooking.ViewModels.BookingViewModel
@{
    ViewData["Title"] = "Request to book";
}

<div class="max-w-7xl mx-auto px-4 py-8">
    <div class="flex items-center mb-8">
        <a href="javascript:history.back()" class="btn btn-circle btn-ghost btn-sm mr-4">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
        </a>
        <h1 class="text-3xl font-bold">Request to book</h1>
    </div>
    
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-12 max-w-6xl">
        <!-- Left Column: Booking Form -->
        <div>
            <!-- Trip Details Section -->
            <div class="border-b border-gray-200 py-6">
                <h2 class="text-xl font-bold mb-4">Your trip</h2>
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <div class="font-medium">Dates</div>
                        <div id="dates-display" class="text-gray-600">@Model.CheckInDate.ToString("MMM dd") – @Model.CheckOutDate.ToString("MMM dd")</div>
                    </div>
                    <button type="button" id="edit-dates-btn" onclick="document.getElementById('editDatesModal').showModal()" class="font-medium underline decoration-1 text-gray-900 hover:text-primary cursor-pointer transition-colors">Edit</button>
                </div>
                <div class="flex justify-between items-center">
                    <div>
                        <div class="font-medium">Guests</div>
                        <div class="text-gray-600"><span id="guest-display">@Model.GuestCount</span> guest@(Model.GuestCount > 1 ? "s" : "")</div>
                    </div>
                </div>
            </div>

            <form asp-action="Create" method="post" class="py-6">
                
                <input type="hidden" asp-for="RoomId" />
                <input type="hidden" asp-for="CheckInDate" />
                <input type="hidden" asp-for="CheckOutDate" />
                
                <div asp-validation-summary="ModelOnly" class="alert alert-error mb-4"></div>
                
                <!-- Guest Count (Hidden/Integrated if relying on previous selection, but allowing edit here) -->
                <div class="form-control mb-6">
                    <label class="label">
                        <span class="label-text text-xl font-bold">Guests</span>
                    </label>
                    <select asp-for="GuestCount" class="select select-bordered w-full max-w-xs" onchange="document.getElementById('guest-display').innerText = this.value">
                        @for (int i = 1; i <= Model.Capacity; i++)
                        {
                            <option value="@i">@i @(i == 1 ? "Guest" : "Guests")</option>
                        }
                    </select>
                    <span asp-validation-for="GuestCount" class="text-error text-sm mt-1"></span>
                </div>
                
                <!-- Payment Section (Mockup) -->
                <div class="border-t border-gray-200 py-6">
                    <h2 class="text-xl font-bold mb-4">Pay with</h2>
                    <div class="flex items-center justify-between border rounded-t-lg p-4 cursor-pointer bg-gray-50">
                        <div class="flex items-center gap-2">
                             <svg class="w-6 h-6 text-gray-600" fill="currentColor" viewBox="0 0 24 24"><path d="M2 5a2 2 0 012-2h16a2 2 0 012 2v14a2 2 0 01-2 2H4a2 2 0 01-2-2V5zm13 8H7v2h8v-2z" /></svg>
                             <span class="font-medium">Credit or debit card</span>
                        </div>
                        <div class="h-4 w-4 bg-black rounded-full"></div>
                    </div>
                     <div class="border border-t-0 rounded-b-lg p-4 cursor-pointer hover:bg-gray-50">
                        <div class="flex items-center gap-2">
                             <span class="font-medium">Pay Later (Cash at Hotel)</span>
                        </div>
                    </div>
                </div>

                <div class="form-control mb-6">
                    <label class="label">
                        <span class="label-text font-bold text-xl">Special Requests</span>
                    </label>
                     <p class="text-sm text-gray-500 mb-2">Have a special request? We'll pass it on to the host.</p>
                    <textarea asp-for="SpecialRequests" 
                              class="textarea textarea-bordered h-24 w-full" 
                              placeholder="Hello, I will be arriving a bit late..."></textarea>
                    <span asp-validation-for="SpecialRequests" class="text-error text-sm mt-1"></span>
                </div>
                
                <div class="divider"></div>
                
                <p class="text-xs text-gray-500 mb-6">
                    By selecting the button below, I agree to the Host's House Rules, Ground rules for guests, and Airbnb's Rebooking and Refund Policy.
                </p>
                
                <button type="submit" class="btn btn-primary btn-lg w-full rounded-lg text-lg font-bold">
                    Confirm and pay
                </button>
            </form>
        </div>
        
        <!-- Right Column: Booking Summary Card -->
        <div class="hidden lg:block relative">
            <div class="sticky top-24">
                <div class="card bg-white border border-gray-200 shadow-xl rounded-2xl overflow-hidden p-6">
                     <div class="flex gap-4 mb-6">
                         <div class="w-24 h-24 bg-gray-200 rounded-lg overflow-hidden flex-shrink-0">
                             <!-- Placeholder Image if no URL -->
                             <img src="https://images.unsplash.com/photo-1566665797739-1674de7a421a?auto=format&fit=crop&w=200&q=80" class="w-full h-full object-cover" alt="Hotel Thumbnail" />
                         </div>
                         <div class="flex flex-col justify-center">
                             <p class="text-xs text-gray-500">Entire hotel room</p>
                             <h3 class="font-bold text-sm">@Model.HotelName</h3>
                             <p class="text-sm">@Model.RoomTypeName</p>
                             <div class="flex items-center text-xs mt-1">
                                 <svg class="w-3 h-3 fill-current text-primary" viewBox="0 0 20 20"><path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z"/></svg> 
                                 <span class="font-bold ml-1">4.85</span> <span class="text-gray-500 ml-1">(120 reviews)</span>
                             </div>
                         </div>
                     </div>
                     
                     <div class="divider my-0"></div>
                     
                     <h3 class="font-bold text-lg py-4">Price details</h3>
                     
                     <div class="space-y-4 text-gray-600">
                        <div class="flex justify-between">
                            <span class="underline decoration-gray-300"><span id="price-detail">@Model.PricePerNight.ToString("N0")₫ x @Model.Nights nights</span></span>
                            <span id="subtotal-price">@Model.TotalPrice.ToString("N0")₫</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="underline decoration-gray-300">Cleaning fee</span>
                            <span>0₫</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="underline decoration-gray-300">Service fee</span>
                            <span>0₫</span>
                        </div>
                    </div>
                    
                    <div class="divider my-4"></div>
                    
                    <div class="flex justify-between text-lg font-bold text-gray-900">
                        <span>Total (VND)</span>
                        <span id="total-price">@Model.TotalPrice.ToString("N0")₫</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Dates Modal -->
<dialog id="editDatesModal" class="modal">
    <div class="modal-box bg-white max-w-md">
        <h3 class="font-bold text-lg mb-4">Edit Dates</h3>
        <div class="space-y-4">
            <div class="form-control">
                <label class="label">
                    <span class="label-text font-medium">Check-in Date</span>
                </label>
                <input type="date" id="edit-checkin" 
                       value="@Model.CheckInDate.ToString("yyyy-MM-dd")"
                       min="@DateTime.Today.ToString("yyyy-MM-dd")"
                       class="input input-bordered w-full" />
            </div>
            <div class="form-control">
                <label class="label">
                    <span class="label-text font-medium">Check-out Date</span>
                </label>
                <input type="date" id="edit-checkout" 
                       value="@Model.CheckOutDate.ToString("yyyy-MM-dd")"
                       min="@DateTime.Today.AddDays(1).ToString("yyyy-MM-dd")"
                       class="input input-bordered w-full" />
            </div>
            <div id="date-error" class="text-error text-sm hidden"></div>
        </div>
        <div class="modal-action">
            <button type="button" id="save-dates" class="btn btn-primary">Save</button>
            <button type="button" onclick="document.getElementById('editDatesModal').close()" class="btn btn-ghost">Cancel</button>
        </div>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const roomId = @Model.RoomId;
            const pricePerNight = @Model.PricePerNight;
            const originalCheckIn = '@Model.CheckInDate.ToString("yyyy-MM-dd")';
            const originalCheckOut = '@Model.CheckOutDate.ToString("yyyy-MM-dd")';
            
            const editDatesModal = document.getElementById('editDatesModal');
            const editCheckin = document.getElementById('edit-checkin');
            const editCheckout = document.getElementById('edit-checkout');
            const saveDatesBtn = document.getElementById('save-dates');
            const dateError = document.getElementById('date-error');
            const datesDisplay = document.getElementById('dates-display');
            
            // Reset modal when opened
            document.getElementById('edit-dates-btn').addEventListener('click', function() {
                editCheckin.value = originalCheckIn;
                editCheckout.value = originalCheckOut;
                dateError.classList.add('hidden');
                dateError.textContent = '';
            });
            
            // Update checkout min date when checkin changes
            editCheckin.addEventListener('change', function() {
                const checkInDate = new Date(this.value);
                checkInDate.setDate(checkInDate.getDate() + 1);
                editCheckout.min = checkInDate.toISOString().split('T')[0];
                
                const currentCheckout = new Date(editCheckout.value);
                if (currentCheckout <= new Date(this.value)) {
                    editCheckout.value = checkInDate.toISOString().split('T')[0];
                }
            });
            
            // Save dates
            saveDatesBtn.addEventListener('click', async function() {
                const checkIn = editCheckin.value;
                const checkOut = editCheckout.value;
                
                // Validation
                if (!checkIn || !checkOut) {
                    dateError.textContent = 'Please select both check-in and check-out dates.';
                    dateError.classList.remove('hidden');
                    return;
                }
                
                const checkInDate = new Date(checkIn);
                const checkOutDate = new Date(checkOut);
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                if (checkInDate < today) {
                    dateError.textContent = 'Check-in date cannot be in the past.';
                    dateError.classList.remove('hidden');
                    return;
                }
                
                if (checkOutDate <= checkInDate) {
                    dateError.textContent = 'Check-out date must be after check-in date.';
                    dateError.classList.remove('hidden');
                    return;
                }
                
                this.disabled = true;
                this.textContent = 'Checking...';
                dateError.classList.add('hidden');
                
                try {
                    const response = await fetch('@Url.Action("RecalculatePrice", "Booking")', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: JSON.stringify({
                            roomId: roomId,
                            checkInDate: checkIn,
                            checkOutDate: checkOut
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error('Failed to recalculate price');
                    }
                    
                    const data = await response.json();
                    
                    if (!data.isAvailable) {
                        dateError.textContent = 'Room is not available for the selected dates.';
                        dateError.classList.remove('hidden');
                        this.disabled = false;
                        this.textContent = 'Save';
                        return;
                    }
                    
                    // Update hidden form fields
                    document.querySelector('input[name="CheckInDate"]').value = checkIn;
                    document.querySelector('input[name="CheckOutDate"]').value = checkOut;
                    
                    // Update display
                    const checkInFormatted = new Date(checkIn).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    const checkOutFormatted = new Date(checkOut).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    datesDisplay.textContent = checkInFormatted + ' – ' + checkOutFormatted;
                    
                    // Update price display
                    const nights = data.nights;
                    document.getElementById('price-detail').textContent = pricePerNight.toLocaleString('en-US') + '₫ x ' + nights + ' nights';
                    document.getElementById('subtotal-price').textContent = data.totalPrice.toLocaleString('en-US') + '₫';
                    document.getElementById('total-price').textContent = data.totalPrice.toLocaleString('en-US') + '₫';
                    
                    // Close modal
                    editDatesModal.close();
                    
                } catch (error) {
                    dateError.textContent = 'An error occurred. Please try again.';
                    dateError.classList.remove('hidden');
                } finally {
                    this.disabled = false;
                    this.textContent = 'Save';
                }
            });
        });
    </script>
}
